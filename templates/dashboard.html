<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        h1, h2, h3 { color: #2c3e50; }
        .main { display: flex; gap: 20px; }
        .left { width: 30%; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .right { width: 70%; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        ul { list-style: none; padding: 0; }
        li { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
        li a { flex: 1; min-width: 200px; }
        a { text-decoration: none; color: #007bff; }
        button, .btn-link { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 2px; text-decoration: none; display: inline-block; font-size: 13px; font-family: Arial;}
        button:hover, .btn-link:hover { background: #0056b3; }
        .btn-green { background-color: #28a745; } .btn-green:hover { background-color: #218838; }
        .btn-purple { background-color: #6f42c1; } .btn-purple:hover { background-color: #5a32a3; }
        .btn-orange { background-color: #fd7e14; } .btn-orange:hover { background-color: #e6700c; }
        .btn-red { background-color: #dc3545; } .btn-red:hover { background-color: #c82333; }
        .btn-grey { background-color: #6c757d; } .btn-grey:hover { background-color: #5a6268; }
        
        img { border: 2px solid #dee2e6; width: 480px; border-radius: 10px; }
        .students { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; } /* Single column for more space */
        .student { padding: 15px; border-radius: 5px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .on_time { background: #28a745; }
        .late { background: #ffc107; color: black; }
        .absent { background: #dc3545; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background: rgba(0,0,0,0.4); }
        .modal-content { background: white; margin: 2% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 1200px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-height: 95vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        
        /* Forms */
        label { display: block; margin: 10px 0 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; margin-bottom: 10px; }
        .form-row { display: flex; gap: 10px; }
        .form-row > div { flex: 1; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Specific areas */
        .add-btns { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-btns button { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .add-btns span { font-size: 20px; line-height: 1; }
        .filter-bar { display: flex; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { flex: 1; min-width: 150px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #dee2e6; text-align: left; }
        .logout-btn { background: #dc3545; color: white; padding: 10px; border-radius: 5px; text-decoration: none; display: inline-block; margin-top: 20px; }
        .stats-container { display: flex; justify-content: space-around; background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .stat { padding: 10px 20px; border-radius: 5px; color: white; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .present { background: #28a745; }
        .late { background: #ffc107; color: #333; }
        .absent { background: #dc3545; }
        .error-msg { color: #dc3545; font-weight: bold; }
        .class-actions { display: flex; gap: 5px; }
        .add-student-buttons { display: flex; gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Welcome, {{ username }} - Dashboard</h1>
    <div class="main">
        <div class="left">
            <div class="add-btns">
                <button class="add-class-btn" onclick="showAddClassModal()"><span style="font-size: 20px;">+</span> Add New Class</button>
                <button class="enroll-student-btn" onclick="showEnrollGlobalModal()"><span style="font-size: 20px;">+</span> Enroll New Student</button>
            </div>
            
            <div id="addClassModal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeAddClassModal()">&times;</span>
                    <h2>Add New Class</h2>
                    <form id="addClassForm">
                        <label>Subject Name:</label><input type="text" id="name" required>
                        <div class="form-row">
                            <div><label>Program (e.g. BSCpE):</label><input type="text" id="class_program" required></div>
                            <div><label>Year:</label><select id="class_year" required><option value="1st">1st</option><option value="2nd">2nd</option><option value="3rd">3rd</option><option value="4th">4th</option></select></div>
                        </div>
                        <div class="form-row">
                            <div><label>Section (e.g. 1-1):</label><input type="text" id="class_section" required></div>
                            <div><label>Day:</label><select id="day" required><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option></select></div>
                        </div>
                        <div class="form-row">
                            <div><label>Start Time:</label><input type="time" id="start_time" required></div>
                            <div><label>End Time:</label><input type="time" id="end_time" required></div>
                        </div>
                        <div class="form-row">
                            <div><label>Semester Start:</label><input type="date" id="start_date" required></div>
                            <div><label>Semester End:</label><input type="date" id="end_date" required></div>
                        </div>
                        <button type="button" onclick="submitAddClass()">Submit</button>
                    </form>
                </div>
            </div>

            <div id="editClassModal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeEditClassModal()">&times;</span>
                    <h2>Edit Class</h2>
                    <form id="editClassForm">
                        <input type="hidden" id="edit_class_id">
                        <label>Subject Name:</label><input type="text" id="edit_name" required>
                        <div class="form-row">
                            <div><label>Program (e.g. BSCpE):</label><input type="text" id="edit_class_program" required></div>
                            <div><label>Year:</label><select id="edit_class_year" required><option value="1st">1st</option><option value="2nd">2nd</option><option value="3rd">3rd</option><option value="4th">4th</option></select></div>
                        </div>
                        <div class="form-row">
                            <div><label>Section (e.g. 1-1):</label><input type="text" id="edit_class_section" required></div>
                            <div><label>Day:</label><select id="edit_day" required><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option></select></div>
                        </div>
                        <div class="form-row">
                            <div><label>Start Time:</label><input type="time" id="edit_start_time" required></div>
                            <div><label>End Time:</label><input type="time" id="edit_end_time" required></div>
                        </div>
                        <div class="form-row">
                            <div><label>Semester Start:</label><input type="date" id="edit_start_date" required></div>
                            <div><label>Semester End:</label><input type="date" id="edit_end_date" required></div>
                        </div>
                        <button type="button" onclick="submitEditClass()">Submit</button>
                    </form>
                </div>
            </div>

            <div id="enrollGlobalModal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeEnrollGlobalModal()">&times;</span>
                    <h2>Enroll Student</h2>
                    <form id="enrollGlobalForm">
                        <div class="form-row">
                            <div><label>Last Name:</label><input type="text" id="last_name" required></div>
                            <div><label>First Name:</label><input type="text" id="first_name" required></div>
                        </div>
                        <div class="form-row">
                            <div><label>Middle Name:</label><input type="text" id="middle_name"></div>
                            <div><label>Student Number:</label><input type="text" id="student_number" required></div>
                        </div>
                        <div class="form-row">
                            <div><label>Suffix:</label><select id="suffix"><option value="">None</option><option value="Jr.">Jr.</option><option value="Sr.">Sr.</option></select></div>
                            <div><label>Year:</label><select id="year" required><option value="1st">1st</option><option value="2nd">2nd</option><option value="3rd">3rd</option><option value="4th">4th</option></select></div>
                        </div>
                        <div class="form-row">
                            <div><label>Program:</label><input type="text" id="program" maxlength="10" oninput="this.value = this.value.toUpperCase()" required></div>
                            <div><label>Section:</label><input type="text" id="section" required><label for="irregular" style="display: block; text-align: center;">Irregular</label><input type="checkbox" id="irregular" style="display: block; margin: 0 auto;"></div>
                        </div>
                        <button type="button" onclick="submitEnrollGlobal(false)">Submit (Skip Face)</button>
                        <button type="button" onclick="submitEnrollUpload()">Submit with Upload</button>
                        <input type="file" id="face_file" accept=".jpg,.jpeg" style="margin-top: 10px;">
                    </form>
                </div>
            </div>

            <button onclick="showAllStudentsModal()">View All Students</button>
            <div id="allStudentsModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeAllStudentsModal()">&times;</span>
                    <h2>All Students Database</h2>
                    <a href="/export_all_students" class="btn-link btn-orange">Export All Students</a>
                    <div class="filter-bar">
                        <div class="filter-group"><label>Search By:</label><select id="allSearchType"><option value="first_name">First Name</option><option value="last_name">Last Name</option><option value="student_number">Student No</option></select></div>
                        <div class="filter-group" style="flex:2;"><label>Search Term:</label><input type="text" id="allSearchVal" oninput="filterAllStudents()"></div>
                        <div class="filter-group"><label>Year:</label><select id="allYear" onchange="filterAllStudents()"><option value="">All</option><option value="1st">1st</option><option value="2nd">2nd</option><option value="3rd">3rd</option><option value="4th">4th</option></select></div>
                        <div class="filter-group"><label>Program:</label><input type="text" id="allProgram" oninput="filterAllStudents()"></div>
                        <div class="filter-group"><label>Section:</label><input type="text" id="allSection" oninput="filterAllStudents()"></div>
                        <div class="filter-group checkbox-label"><label>Irregular Only:</label><input type="checkbox" id="allIrregular" onclick="filterAllStudents()"></div>
                    </div>
                    <table id="allStudentsTable">
                        <thead><tr><th>Student No</th><th>Last Name</th><th>First Name</th><th>Year</th><th>Program</th><th>Section</th><th>Has Face</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div class="pagination" style="margin-top: 15px; text-align: center;"><button onclick="changePage(-1)">Previous</button><span id="pageInfo" style="margin: 0 10px;"></span><button onclick="changePage(1)">Next</button></div>
                </div>
            </div>

            <div id="updateFaceModal" class="modal"><div class="modal-content" style="max-width: 600px;"><span class="close" onclick="closeUpdateFaceModal()">&times;</span><h2>Update Face</h2><input type="hidden" id="update_student_number"><img id="updateCaptureFace" src="/stream" style="width:100%"><button type="button" onclick="submitUpdateFace()">Capture</button><input type="file" id="upload_file" accept=".jpg,.jpeg"><button type="button" onclick="submitUploadFace()">Upload</button></div></div>
            <div id="editStudentModal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeEditStudentModal()">&times;</span>
                    <h2>Edit Student</h2>
                    <form id="editStudentForm">
                        <input type="hidden" id="edit_student_number">
                        <div class="form-row">
                            <div><label>Last Name:</label><input type="text" id="edit_last_name" required></div>
                            <div><label>First Name:</label><input type="text" id="edit_first_name" required></div>
                        </div>
                        <div class="form-row">
                            <div><label>Middle Name:</label><input type="text" id="edit_middle_name"></div>
                            <div><label>Student Number:</label><input type="text" id="edit_student_number_disp" disabled></div>
                        </div>
                        <div class="form-row">
                            <div><label>Suffix:</label><select id="edit_suffix"><option value="">None</option><option value="Jr.">Jr.</option><option value="Sr.">Sr.</option></select></div>
                            <div><label>Year:</label><select id="edit_year" required><option value="1st">1st</option><option value="2nd">2nd</option><option value="3rd">3rd</option><option value="4th">4th</option></select></div>
                        </div>
                        <div class="form-row">
                            <div><label>Program:</label><input type="text" id="edit_program" required></div>
                            <div><label>Section:</label><input type="text" id="edit_section" required><label for="edit_irregular" style="display: block; text-align: center;">Irregular</label><input type="checkbox" id="edit_irregular" style="display: block; margin: 0 auto;"></div>
                        </div>
                        <button type="button" onclick="submitEditStudent()">Submit</button>
                    </form>
                </div>
            </div>

            <h2>Your Classes</h2>
            <select id="dayFilter" onchange="filterClassesByDay(this.value)">
                <option value="">All Days</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option>
            </select>
            <ul id="classesList">
                {% for cls in all_classes %}
                    <li data-day="{{ cls[2] }}">
                        <a href="/dashboard?class_id={{ cls[0] }}{% if selected_date %}&date={{ selected_date }}{% endif %}">
                            {{ cls[1] }} - {{ cls[6] }} {{ cls[7] }} Year ({{ cls[5] }}) ({{ cls[2] }} {{ cls[3] }}-{{ cls[4] }})
                        </a>
                        <div class="class-actions">
                            <button class="btn-grey" onclick="showEditClassModal({{ cls[0] }}, '{{ cls[1] }}', '{{ cls[2] }}', '{{ cls[3] }}', '{{ cls[4] }}', '{{ cls[8] }}', '{{ cls[9] }}', '{{ cls[6] }}', '{{ cls[7] }}', '{{ cls[5] }}')">Edit</button>
                            <button class="btn-red" onclick="showAuthModal('delete_class', null, {{ cls[0] }})">Delete</button>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="right">
            {% if selected_class %}
                <div class="calendar">
                    <h2>Calendar</h2>
                    <input type="date" id="calendarDate" value="{{ selected_date or '' }}" onchange="loadClassesForDate(this.value)">
                </div>
                {% if selected_date %}
                    <div class="header-actions">
                        <h2>{{ selected_class.name }} - {{ selected_class.program }} {{ selected_class.year }} Year ({{ selected_class.section }})</h2>
                        <div>
                            <a href="/export_course?class_id={{ selected_class.id }}" class="btn-link btn-green">Export Semester</a>
                            <a href="/export_session?class_id={{ selected_class.id }}&date={{ selected_date }}" class="btn-link btn-purple">Export Daily</a>
                            <a href="/export_all_attendance" class="btn-link btn-orange">Export All Data</a>
                        </div>
                    </div>
                    {% if error_msg %}
                        <p class="error-msg">{{ error_msg }}</p>
                    {% else %}
                        <div class="stats-container" id="statsContainer">
                            <span class="stat present">Present: {{ present }}</span>
                            <span class="stat late">Late: {{ late }}</span>
                            <span class="stat absent">Absent: {{ absent }}</span>
                        </div>
                        <img src="/stream" id="cam">
                        <div class="students" style="margin-top: 10px;" id="studentsList">
                            {% for sid, info in students_statuses.items() %}
                                <div class="student {{ info.status }}" data-sn="{{ sid }}">
                                    <span>{{ info.name }} ({{ sid }}) - {{ info.status | replace('_', ' ') | title }}</span>
                                    <div>
                                        {% if info.status == 'absent' %}
                                            <button class="btn-green" onclick="showAuthModal('mark_present', '{{ sid }}', {{ selected_class.id }})">Mark Present</button>
                                        {% else %}
                                            <button class="btn-grey" onclick="showAuthModal('clear_attendance', '{{ sid }}', {{ selected_class.id }})">Clear Status</button>
                                        {% endif %}
                                        <button class="btn-red" onclick="showAuthModal('remove_student', '{{ sid }}', {{ selected_class.id }})">Remove</button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <button onclick="importStudentsFromSection({{ selected_class.id }})" class="btn-orange">
                            Import All Students from {{ selected_class.program }} {{ selected_class.year }} Year ({{ selected_class.section }})
                        </button>
                        <div class="add-student-buttons">
                            <button onclick="showAddStudentsModal({{ selected_class.id }})">Manually Add Students</button>
                        </div>

                        <div id="addStudentsModal" class="modal">
                            <div class="modal-content">
                                <span class="close" onclick="closeAddStudentsModal()">&times;</span>
                                <h2>Add Students</h2>
                                <div class="filter-bar">
                                    <div class="filter-group"><label>Search By:</label><select id="addSearchType"><option value="first_name">First Name</option><option value="last_name">Last Name</option><option value="student_number">Student No</option></select></div>
                                    <div class="filter-group" style="flex:2;"><label>Search:</label><input type="text" id="addSearchVal" oninput="filterStudents()"></div>
                                    <div class="filter-group"><label>Year:</label><select id="addYear" onchange="filterStudents()"><option value="">All</option><option value="1st">1st</option><option value="2nd">2nd</option><option value="3rd">3rd</option><option value="4th">4th</option></select></div>
                                    <div class="filter-group"><label>Program:</label><input type="text" id="addProgram" oninput="filterStudents()"></div>
                                    <div class="filter-group"><label>Section:</label><input type="text" id="addSection" oninput="filterStudents()"></div>
                                    <div class="filter-group checkbox-label"><label>Irregular Only:</label><input type="checkbox" id="addIrregular" onclick="filterStudents()"></div>
                                </div>
                                <table id="addStudentsTable"><thead><tr><th>Select</th><th>Student No</th><th>Name</th></tr></thead><tbody></tbody></table><button onclick="submitAddStudents()">Add Selected</button>
                            </div>
                        </div>

                        <div id="authModal" class="modal">
                            <div class="modal-content" style="max-width: 400px; text-align: center;">
                                <span class="close" onclick="closeAuthModal()">&times;</span>
                                <h2 id="authModalTitle">Authenticate</h2>
                                <p id="authModalMsg">Please enter credentials to continue.</p>
                                <form id="authForm">
                                    <input type="hidden" id="auth_action">
                                    <input type="hidden" id="auth_student_number">
                                    <input type="hidden" id="auth_class_id">
                                    <label style="text-align: left;">Username:</label>
                                    <input type="text" id="auth_username" required>
                                    <label style="text-align: left;">Password:</label>
                                    <input type="password" id="auth_password" required>
                                    <button type="button" onclick="submitAuthAction()">Confirm</button>
                                </form>
                            </div>
                        </div>

                        <h3>Recent Attendance</h3>
                        <ul id="list"></ul>
                    {% endif %}
                {% else %}
                    <p>Please select a date from the calendar to view attendance.</p>
                {% endif %}
            {% else %}
                <p>Select a class to view details.</p>
            {% endif %}
        </div>
    </div>
    <a href="/logout" class="logout-btn">Logout</a>

    <script>
    let currentPage = 1; const pageSize = 10;
    
    let currentSn = '';
    let currentCid = '';

    function showAuthModal(action, sn, cid) {
        console.log("showAuthModal called with action:", action, "sn:", sn, "cid:", cid);  // Debug log
        currentSn = sn || '';
        currentCid = cid || '';
        document.getElementById('auth_action').value = action;
        document.getElementById('auth_student_number').value = currentSn;
        document.getElementById('auth_class_id').value = currentCid;
        console.log("Set hidden inputs - student_number:", document.getElementById('auth_student_number').value, "class_id:", document.getElementById('auth_class_id').value);  // Debug log
        
        let title = "Authenticate";
        let msg = "Enter credentials:";
        if(action === 'remove_student') { title = "Remove Student"; msg = "Verify to remove student from class."; }
        if(action === 'mark_present') { title = "Mark Present"; msg = "Verify to manually mark student present."; }
        if(action === 'clear_attendance') { title = "Clear Attendance"; msg = "Verify to delete attendance record."; }
        if(action === 'delete_class') { title = "Delete Class"; msg = "Verify to delete class."; }
        
        document.getElementById('authModalTitle').innerText = title;
        document.getElementById('authModalMsg').innerText = msg;
        document.getElementById('authModal').style.display = 'block';
    }
    function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; document.getElementById('authForm').reset(); currentSn = ''; currentCid = ''; }
    
    async function submitAuthAction() {
        const action = document.getElementById('auth_action').value;
        const data = {
            username: document.getElementById('auth_username').value,
            password: document.getElementById('auth_password').value,
            class_id: currentCid,
            student_number: currentSn,
            date: "{{ selected_date }}" || new Date().toISOString().split('T')[0]
        };
        if (action !== 'mark_present' && action !== 'clear_attendance' && action !== 'remove_student') {
            delete data.student_number;
            delete data.date;
        }
        console.log("Sending data to server:", data);  // Debug log for sent data
        
        let url = '';
        if(action === 'remove_student') url = '/remove_student_from_class';
        if(action === 'mark_present') url = '/manual_attendance';
        if(action === 'clear_attendance') url = '/clear_attendance';
        if(action === 'delete_class') url = '/delete_class';
        
        const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
        const json = await res.json();
        
        if(res.ok) { closeAuthModal(); location.reload(); }
        else { alert("Error: " + (json.error || "Action failed")); }
    }

    // --- OTHER FUNCTIONS (Add/Edit/Enroll/Filter) preserved ---
    function showModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showAddClassModal() { document.getElementById('addClassForm').reset(); showModal('addClassModal'); }
    function closeAddClassModal() { closeModal('addClassModal'); }
    async function submitAddClass() {
        const data = {
            name: document.getElementById('name').value,
            program: document.getElementById('class_program').value,
            year: document.getElementById('class_year').value,
            section: document.getElementById('class_section').value,
            day: document.getElementById('day').value,
            start_time: document.getElementById('start_time').value,
            end_time: document.getElementById('end_time').value,
            start_date: document.getElementById('start_date').value,
            end_date: document.getElementById('end_date').value
        };
        await fetch('/dashboard', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)});
        closeAddClassModal(); location.reload();
    }

    function showEditClassModal(cid, name, day, start, end, s_date, e_date, program, year, section) {
        document.getElementById('edit_class_id').value = cid;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_day').value = day;
        document.getElementById('edit_start_time').value = start;
        document.getElementById('edit_end_time').value = end;
        document.getElementById('edit_start_date').value = s_date;
        document.getElementById('edit_end_date').value = e_date;
        document.getElementById('edit_class_program').value = program;
        document.getElementById('edit_class_year').value = year;
        document.getElementById('edit_class_section').value = section;
        showModal('editClassModal');
    }
    function closeEditClassModal() { closeModal('editClassModal'); }
    async function submitEditClass() {
        const data = {
            class_id: document.getElementById('edit_class_id').value,
            name: document.getElementById('edit_name').value,
            program: document.getElementById('edit_class_program').value,
            year: document.getElementById('edit_class_year').value,
            section: document.getElementById('edit_class_section').value,
            day: document.getElementById('edit_day').value,
            start_time: document.getElementById('edit_start_time').value,
            end_time: document.getElementById('edit_end_time').value,
            start_date: document.getElementById('edit_start_date').value,
            end_date: document.getElementById('edit_end_date').value
        };
        await fetch('/edit_class', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)});
        closeEditClassModal(); location.reload();
    }
    async function importStudentsFromSection(cid) {
        if(confirm("Import all students matching this class section?")) {
            const res = await fetch('/import_section_students', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({class_id: cid})});
            location.reload();
        }
    }
    
    function showEnrollGlobalModal() { document.getElementById('enrollGlobalForm').reset(); showModal('enrollGlobalModal'); }
    function closeEnrollGlobalModal() { closeModal('enrollGlobalModal'); }
    async function submitEnrollGlobal(capture) {
        const form = document.getElementById('enrollGlobalForm');
        const data = {
            student_number: form.student_number.value,
            last_name: form.last_name.value,
            first_name: form.first_name.value,
            middle_name: form.middle_name.value,
            year: form.year.value,
            program: form.program.value,
            section: form.section.value + (document.getElementById('irregular').checked ? ' IRREG' : ''),
            suffix: form.suffix.value
        };
        const res = await fetch('/enroll_global', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        closeEnrollGlobalModal(); 
    }
    async function submitEnrollUpload() {
        const form = document.getElementById('enrollGlobalForm');
        const data = {
            student_number: form.student_number.value,
            last_name: form.last_name.value,
            first_name: form.first_name.value,
            middle_name: form.middle_name.value,
            year: form.year.value,
            program: form.program.value,
            section: form.section.value + (document.getElementById('irregular').checked ? ' IRREG' : ''),
            suffix: form.suffix.value
        };
        const res = await fetch('/enroll_global', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if(res.ok) {
            const file = document.getElementById('face_file').files[0];
            if(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('student_number', data.student_number);
                await fetch('/upload_face', { method: 'POST', body: formData });
            }
        }
        closeEnrollGlobalModal();
    }
    
    function showAllStudentsModal() { currentPage=1; showModal('allStudentsModal'); filterAllStudents(); }
    function closeAllStudentsModal() { closeModal('allStudentsModal'); }
    async function filterAllStudents() {
        const type=document.getElementById('allSearchType').value, val=document.getElementById('allSearchVal').value, yr=document.getElementById('allYear').value, pr=document.getElementById('allProgram').value, sc=document.getElementById('allSection').value, irreg=document.getElementById('allIrregular').checked;
        const res = await fetch(`/get_students?year=${yr}&program=${pr}&section=${sc}&search_type=${type}&search_val=${val}&is_irregular=${irreg}&offset=${(currentPage-1)*pageSize}&limit=${pageSize}`);
        const data = await res.json();
        const tbody = document.querySelector('#allStudentsTable tbody'); tbody.innerHTML='';
        data.students.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s[0]}</td><td>${s[2]}</td><td>${s[1]}</td><td>${s[3]}</td><td>${s[4]}</td><td>${s[5]}</td><td>${s[8] ? 'Yes' : 'No'}</td><td><button class="btn-grey" onclick="showEditStudentModal('${s[0]}','${s[1]}','${s[2]}','${s[6]}','${s[3]}','${s[4]}','${s[5]}','${s[7]}')">Edit</button><button class="btn-grey" onclick="showUpdateFaceModal('${s[0]}')">Face</button></td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('pageInfo').innerText = `Page ${currentPage}`;
    }
    function changePage(d) { currentPage+=d; if(currentPage<1) currentPage=1; filterAllStudents(); }
    
    function showEditStudentModal(sn, fn, ln, mn, yr, prog, sec, suf) {
        document.getElementById('edit_student_number').value = sn;
        document.getElementById('edit_student_number_disp').value = sn;
        document.getElementById('edit_first_name').value = fn;
        document.getElementById('edit_last_name').value = ln;
        document.getElementById('edit_middle_name').value = (mn && mn !== 'None') ? mn : '';
        document.getElementById('edit_year').value = yr;
        document.getElementById('edit_program').value = prog;
        document.getElementById('edit_section').value = sec.replace(' IRREG', '');
        document.getElementById('edit_suffix').value = (suf && suf !== 'None') ? suf : '';
        document.getElementById('edit_irregular').checked = sec.includes(' IRREG');
        document.getElementById('editStudentModal').style.display = 'block';
    }
    function closeEditStudentModal() { document.getElementById('editStudentModal').style.display = 'none'; }
    async function submitEditStudent() {
        const data = {
            student_number: document.getElementById('edit_student_number').value,
            first_name: document.getElementById('edit_first_name').value,
            last_name: document.getElementById('edit_last_name').value,
            middle_name: document.getElementById('edit_middle_name').value,
            year: document.getElementById('edit_year').value,
            program: document.getElementById('edit_program').value,
            section: document.getElementById('edit_section').value + (document.getElementById('edit_irregular').checked ? ' IRREG' : ''),
            suffix: document.getElementById('edit_suffix').value
        };
        const res = await fetch('/edit_student', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (res.ok) { closeEditStudentModal(); filterAllStudents(); location.reload(); } else { alert("Error editing student"); }
    }

    function showUpdateFaceModal(sn) { document.getElementById('update_student_number').value = sn; document.getElementById('updateFaceModal').style.display = 'block'; }
    function closeUpdateFaceModal() { document.getElementById('updateFaceModal').style.display = 'none'; }
    async function submitUpdateFace() {
        const sn = document.getElementById('update_student_number').value;
        const res = await fetch(`/capture_global?student_number=${sn}`);
        const json = await res.json();
        if (res.ok && json.status === "updated") { 
            closeUpdateFaceModal(); 
            alert("Face updated successfully!"); 
            filterAllStudents(); 
        } else { 
            alert("Error updating face: " + (json.error || "Unknown error")); 
        }
    }
    async function submitUploadFace() {
        const sn = document.getElementById('update_student_number').value;
        const file = document.getElementById('upload_file').files[0];
        if (!file) return alert("No file selected");
        const formData = new FormData();
        formData.append('file', file);
        formData.append('student_number', sn);
        const res = await fetch('/upload_face', { method: 'POST', body: formData });
        if (res.ok) { closeUpdateFaceModal(); alert("Face uploaded successfully!"); filterAllStudents(); } else { alert("Error uploading face"); }
    }
    
    function showAddStudentsModal(cid) { window.currentClassId = cid; showModal('addStudentsModal'); filterStudents(); }
    function closeAddStudentsModal() { closeModal('addStudentsModal'); }
    async function filterStudents() {
        const type = document.getElementById('addSearchType').value, val = document.getElementById('addSearchVal').value, yr = document.getElementById('addYear').value, pr = document.getElementById('addProgram').value, sc = document.getElementById('addSection').value, irreg = document.getElementById('addIrregular').checked;
        const res = await fetch(`/get_students?year=${yr}&program=${pr}&section=${sc}&search_type=${type}&search_val=${val}&is_irregular=${irreg}&limit=50`);
        const data = await res.json();
        const tbody = document.querySelector('#addStudentsTable tbody'); tbody.innerHTML = '';
        data.students.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="checkbox" value="${s[0]}"></td><td>${s[0]}</td><td>${s[2]}, ${s[1]}</td>`;
            tbody.appendChild(tr);
        });
    }
    async function submitAddStudents() {
        const cbs = document.querySelectorAll('#addStudentsTable input:checked');
        const sns = Array.from(cbs).map(cb => cb.value);
        await fetch('/add_students_to_class', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({class_id: window.currentClassId, student_numbers: sns})});
        location.reload();
    }

    // Attendance
    async function attendance(classId) {
        try {
            console.log("Running attendance check");
            const res = await fetch(`/capture_attendance?class_id=${classId}`);
            if (!res.ok) {
                console.error("Fetch error:", res.status);
                return;
            }
            const data = await res.json();
            console.log("Attendance response:", data);
            if (data.status === "match") {
                console.log("Match found, updating UI...");
                updateStudentStatus(data.student_number, data.attendance_status);
                refreshRecentAttendance(classId);
            }
        } catch (error) {
            console.error("Attendance fetch error:", error);
        }
    }

    // NEW: Function to update a single student's status in the UI without full reload
    function updateStudentStatus(sn, newStatus) {
        const studentDiv = document.querySelector(`.student[data-sn="${sn}"]`);
        if (studentDiv) {
            const titleStatus = newStatus.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
            studentDiv.className = `student ${newStatus}`;
            studentDiv.querySelector('span').innerHTML = studentDiv.querySelector('span').innerHTML.replace(/ - .*$/, ` - ${titleStatus}`);
            const buttonsDiv = studentDiv.querySelector('div');
            buttonsDiv.innerHTML = '';
            if (newStatus === 'absent') {
                buttonsDiv.innerHTML = '<button class="btn-green" onclick="showAuthModal(\'mark_present\', \'' + sn + '\', ' + '{{ selected_class.id }}' + ')">Mark Present</button>';
            } else {
                buttonsDiv.innerHTML = '<button class="btn-grey" onclick="showAuthModal(\'clear_attendance\', \'' + sn + '\', ' + '{{ selected_class.id }}' + ')">Clear Status</button>';
            }
            buttonsDiv.innerHTML += '<button class="btn-red" onclick="showAuthModal(\'remove_student\', \'' + sn + '\', ' + '{{ selected_class.id }}' + ')">Remove</button>';
            // Update stats
            updateStats();
        }
    }

    // NEW: Function to recalculate and update stats
    function updateStats() {
        const students = document.querySelectorAll('.student');
        let present = 0, late = 0, absent = 0;
        students.forEach(s => {
            if (s.classList.contains('on_time')) present++;
            else if (s.classList.contains('late')) late++;
            else if (s.classList.contains('absent')) absent++;
        });
        document.querySelector('.present').innerText = `Present: ${present}`;
        document.querySelector('.late').innerText = `Late: ${late}`;
        document.querySelector('.absent').innerText = `Absent: ${absent}`;
    }

    async function refreshRecentAttendance(classId) {
        try {
            const res = await fetch(`/attendance?class_id=${classId}`);
            const data = await res.json();
            const list = document.getElementById('list'); list.innerHTML="";
            data.forEach(r => {
                const li = document.createElement("li"); li.textContent = `${r[0] || 'Unknown'} - ${r[1]} (${r[2]})`; list.appendChild(li);
            });
        } catch (error) {
            console.error("Refresh recent attendance error:", error);
        }
    }
    async function refresh(classId) {
        if(!classId) return;
        await refreshRecentAttendance(classId);
    }
    function filterClassesByDay(day) {
        localStorage.setItem('selectedDay', day);
        const list = document.getElementById('classesList').getElementsByTagName('li');
        for(let li of list) li.style.display = (day === '' || li.dataset.day === day) ? 'flex' : 'none';
    }
    function loadClassesForDate(date) { location.href = `/dashboard?{% if selected_class %}class_id={{ selected_class.id }}&{% endif %}date=${date}`; }

    var classDay = '{{ selected_class.day if selected_class else "" }}';
    var dayMap = {
        'Sunday': 0,
        'Monday': 1,
        'Tuesday': 2,
        'Wednesday': 3,
        'Thursday': 4,
        'Friday': 5,
        'Saturday': 6
    };

    function validateAndLoadDate(input) {
        var selectedDate = new Date(input.value);
        if (isNaN(selectedDate.getTime())) return;

        if (classDay && selectedDate.getDay() !== dayMap[classDay]) {
            alert("Selected date does not match the class day (" + classDay + "). Please select a valid date.");
            input.value = input.oldValue || '';
            return;
        }
        input.oldValue = input.value;
        loadClassesForDate(input.value);
    }

    document.getElementById('calendarDate').oldValue = document.getElementById('calendarDate').value;

    const dayFilter = document.getElementById('dayFilter');
    const savedDay = localStorage.getItem('selectedDay');
    if (savedDay) {
        dayFilter.value = savedDay;
        filterClassesByDay(savedDay);
    }

    var selectedDate = '{{ selected_date }}';
    var today = '{{ today }}';
    {% if selected_class %}
    setInterval(() => refresh({{ selected_class.id | tojson }}), 3000); 
    setInterval(() => attendance({{ selected_class.id | tojson }}), 5000);
    {% endif %}
    </script>
</body>
</html>